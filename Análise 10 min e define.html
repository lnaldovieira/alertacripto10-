<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alerta de 10% - Criptomoedas Binance</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 20px; }
        #status { font-size: 18px; margin-top: 10px; }
        #historyTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 8px; text-align: center; }
        th { background-color: #f4f4f4; }
        button { margin-top: 10px; padding: 10px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üöÄ Alerta de 10% - Binance</h1>
    <p id="status">üîÑ Buscando tokens...</p>
    <button onclick="clearHistory()">üóëÔ∏è Limpar Hist√≥rico</button>

    <h2>üìú Tokens que Atingiram 10% de Alta</h2>
    <table id="historyTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Token</th>
                <th>Abertura</th>
                <th>Valor Atual</th>
                <th>Varia√ß√£o (%)</th>
                <th>Hor√°rio</th>
                <th>Status 12%</th>
            </tr>
        </thead>
        <tbody id="history"></tbody>
    </table>

    <script>
        let tokenList = [];
        let tokenData = {};
        let alertHistory = [];
        let alertCounter = 0;
        let lastResetDate = new Date().toISOString().split("T")[0];

        // Solicitar permiss√£o para notifica√ß√µes ao carregar a p√°gina
        document.addEventListener("DOMContentLoaded", () => {
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    console.log("Permiss√£o de notifica√ß√£o:", permission);
                });
            }
        });

        async function getAllTokens() {
            try {
                let response = await fetch("https://api.binance.com/api/v3/exchangeInfo");
                let data = await response.json();
                tokenList = data.symbols
                    .filter(symbol => symbol.quoteAsset === "USDT" && symbol.status === "TRADING")
                    .map(symbol => symbol.symbol.toLowerCase());

                document.getElementById("status").textContent = `üì° Monitorando ${tokenList.length} tokens...`;

                // Iniciar monitoramento de pre√ßos
                connectWebSocket();
            } catch (error) {
                document.getElementById("status").textContent = "‚ùå Erro ao buscar tokens.";
            }
        }

        function connectWebSocket() {
            let streams = tokenList.map(token => `${token}@kline_1d`).join("/");
            let socket = new WebSocket(`wss://stream.binance.com:9443/ws/${streams}`);

            socket.onmessage = function(event) {
                let data = JSON.parse(event.data);
                let token = data.s;
                let openPrice = parseFloat(data.k.o); // Garante o pre√ßo correto de abertura
                let currentPrice = parseFloat(data.k.c); // Garante o pre√ßo correto atual
                let percentageChange = ((currentPrice - openPrice) / openPrice) * 100;
                let now = new Date();
                let timeString = now.toLocaleTimeString();
                let currentDate = now.toISOString().split("T")[0];

                console.log(`Token: ${token} | Abertura: ${openPrice} | Atual: ${currentPrice} | Varia√ß√£o: ${percentageChange.toFixed(2)}%`);

                // Resetar hist√≥rico diariamente
                if (currentDate !== lastResetDate) {
                    clearHistory();
                    lastResetDate = currentDate;
                }

                if (!tokenData[token]) {
                    tokenData[token] = { open: openPrice, alerted10: false, alerted12: false, status: "üîÑ Aguardando" };
                }

                // Enviar notifica√ß√£o ao atingir 10%
                if (!tokenData[token].alerted10 && percentageChange >= 10) {
                    alertCounter++;
                    tokenData[token].alerted10 = true;
                    sendNotification(token, 10);
                    tokenData[token].status = "üîÑ Aguardando 12%";

                    alertHistory.push({
                        id: alertCounter,
                        token,
                        openPrice,
                        currentPrice,
                        percentageChange,
                        time: timeString,
                        status: "üîÑ Aguardando 12%"
                    });

                    updateHistoryTable();
                }

                // Verificar se atingiu 12% sem cair para o pre√ßo de abertura
                if (tokenData[token].alerted10 && !tokenData[token].alerted12) {
                    if (percentageChange >= 12) {
                        tokenData[token].alerted12 = true;
                        tokenData[token].status = "‚úÖ Sucesso";
                        updateHistoryTable();
                    } else if (currentPrice <= openPrice) {
                        tokenData[token].status = "‚ùå N√£o manteve valoriza√ß√£o";
                        updateHistoryTable();
                    }
                }
            };
        }

        function updateHistoryTable() {
            document.getElementById("history").innerHTML = alertHistory.map(entry => {
                let tokenStatus = tokenData[entry.token] ? tokenData[entry.token].status : "üîÑ Aguardando";
                return `<tr>
                    <td>${entry.id}</td>
                    <td>${entry.token}</td>
                    <td>$${entry.openPrice.toFixed(4)}</td>
                    <td>$${entry.currentPrice.toFixed(4)}</td>
                    <td>${entry.percentageChange.toFixed(2)}%</td>
                    <td>${entry.time}</td>
                    <td>${tokenStatus}</td>
                </tr>`;
            }).join("");
        }

        function sendNotification(token, percentage) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`üö® ${token} atingiu +${percentage}%!`);
            }
        }

        function clearHistory() {
            alertHistory = [];
            alertCounter = 0;
            tokenData = {};
            document.getElementById("history").innerHTML = "";
        }

        getAllTokens();
    </script>
</body>
</html>
